---
layout: single
title:  "ë”¥ëŸ¬ë‹ íŒŒì´í”„ë¼ì¸ ë¦¬íŒ©í† ë§"
categories: Code
tag: [multi-gpu, DistributedDataParallel, DDP, TorchMetrics, Pytorch_lightning, Hydra-core TorchMetrics, PyTorch]
toc: true
author_profile: false
sidebar:
    nav: "docs"
search: true
typora-root-url: "../"
---



#  í”„ë¡œì íŠ¸ ê°œë°œ ê³„ê¸°

ğŸ‘‰ğŸ»[íŒŒì´í”„ë¼ì¸ ê¹ƒí—ˆë¸Œ](https://github.com/DimensionSTP/multimodal-transformer "ì²˜ìŒìœ¼ë¡œ êµ¬ì¡°í™”í•œ ë”¥ëŸ¬ë‹ íŒŒì´í”„ë¼ì¸")

ëŒ€í•™ì› ì…í•™ í›„, ì—°êµ¬ì‹¤ê³¼ ìì£¼ í˜‘ì—…í•˜ëŠ” ETRIì—ì„œ ì£¼ìµœí•œ ë…¼ë¬¸ ê²½ì§„ëŒ€íšŒì— ì°¸ì—¬í–ˆë‹¤.

ë‹¤ì–‘í•œ ìƒí™©ì˜ ëŒ€í™”ì—ì„œ ì„±ìš° í˜¹ì€ ì¼ë°˜ì¸ì˜ ìŒì„±, ìŒì„±ì˜ ìë§‰, ê·¸ë¦¬ê³  ìƒë¦¬ì‹ í˜¸ê°€ í¬í•¨ëœ ë°ì´í„°ì…‹ìœ¼ë¡œ ê°ì •ì„ ë¶„ë¥˜í•˜ê³  ì„±ê³¼ì— ëŒ€í•œ ë…¼ë¬¸ì„ ì“°ëŠ” ê²½ì§„ëŒ€íšŒì˜€ë‹¤.

ë‹¹ì‹œ ì‹œê°„ ì œì•½ìœ¼ë¡œ ì¸í•´ audio, text 2ê°œì˜ modalityë§Œ ì´ìš©í•˜ì—¬ ê°ì„±ì„ ë¶„ë¥˜í•˜ê³ ì í–ˆê³ , ê°ê° pretrained ëœ Hubertì™€ RoBERTa ëª¨ë¸ë“¤ì„ ë¶ˆëŸ¬ì™€ì„œ ê²½ì§„ëŒ€íšŒì˜ ë°ì´í„°ì…‹ìœ¼ë¡œ fine-tuneí–ˆë‹¤. 

ì´í›„ ê° modalityì— í•´ë‹¹í•˜ëŠ” ëª¨ë¸ì— íƒœì›Œ audio, text embedding vectorë¥¼ ì¶”ì¶œ ë’¤, cross attention transformerë¥¼ êµ¬ì¶•í•˜ì—¬ embedding vectorë¼ë¦¬ cross attentionsì„ ì§„í–‰í•˜ëŠ” deep fusionì„ í†µí•´ ì„±ëŠ¥ í–¥ìƒì„ ë„ëª¨í–ˆë‹¤.

ê²°ë¡ ì ìœ¼ë¡œ, ê°ì„± label ë‹¹ audio, textì˜ ê¸¸ì´ê°€ ì§§ê³ , ì´ë¯¸ well-pretrainedëœ ê° modalityì˜ ëª¨ë¸ì—ì„œ ì¶”ì¶œí•œ embedding vectorë“¤ì„ cross-attentionì„ í†µí•´ deep fusioní•˜ëŠ” ê²ƒì´ ì˜¤íˆë ¤ over-fittingìœ¼ë¡œ ì„±ëŠ¥ì„ ì•…í™”ì‹œì¼°ë‹¤.

fine-tuned single-modality modelì˜ logit ê°’ë“¤ì„ soft votingí•˜ëŠ” shallow fusionì´ ë” ì¢‹ì€ ì„±ëŠ¥ì„ ë‚´ì„œ í•´ë‹¹ ê²°ê³¼ë¡œ ë§ˆë¬´ë¦¬í–ˆë‹¤.



ë‹¤ë§Œ, ì´ ë•Œ ë°ì´í„°ì…‹ì˜ ì „ì²˜ë¦¬, ëª¨ë¸ì˜ ì˜µì…˜ ë“±ì„ ë°”ê¿”ê°€ë©° ë°˜ë³µ ì‹¤í—˜ì„ í•´ì•¼í–ˆê³ , ê·¸ ê²°ê³¼ë¥¼ ê¸°ë¡í•´ì•¼í–ˆë‹¤.

ì´ì „ì— ê°œì¸ì ìœ¼ë¡œ ì°¸ì—¬í–ˆë˜ ê²½ì§„ëŒ€íšŒëŠ” ì§§ì€ í˜¸í¡ì— ìˆ˜ê¸°ë¡œ ê¸°ë¡í–ˆìœ¼ë‚˜, ë³¸ê²©ì ìœ¼ë¡œ êµ¬ì¡°í™”ëœ íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ì–´ì„œ, yaml í˜•ì‹ì˜ ì„¤ì • íŒŒì¼ì— ì˜µì…˜ì„ ë°”ê¿”ì£¼ëŠ” ê²ƒë§Œìœ¼ë¡œ í•´ë‹¹ ì˜µì…˜ìœ¼ë¡œ ì‹¤í—˜í•˜ê³  ìë™ìœ¼ë¡œ ê¸°ë¡ë˜ê¸¸ ì›í–ˆë‹¤.

ë”°ë¼ì„œ, PyTorch-Lightning, Hydra-Coreë¥¼ ì´ìš©í•˜ì—¬ êµ¬ì¡°ë¥¼ ì¡ì•„ì„œ ì„¤ì • íŒŒì¼, ë°ì´í„°ì…‹ê³¼ ëª¨ë¸ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€ or ìˆ˜ì •í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ì—ˆê³ , ì´í›„ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë“¤ì˜ ê¸°ë³¸ êµ¬ì¡°ê°€ ë˜ìˆë‹¤.

 

# ë”¥ëŸ¬ë‹ íŒŒì´í”„ë¼ì¸ í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸

ìµœê·¼, ì§€ì› ë°›ëŠ” ì„œë²„ì˜ êµì²´ë¡œ ì¸í•´, GPU ì¢…ë¥˜, OS ë° ê¸°íƒ€ ì„¤ì •ê³¼ ê°€ì´ë“œë¼ì¸ ë³€ë™ì´ ìˆì—ˆê³ , ê±°ê¸°ì— ë§ì¶° ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì„ ì—…ë°ì´íŠ¸í•´ì•¼ë§Œ í–ˆë‹¤.

ì•½ 1ë…„ ë°˜ë§Œì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—…ë°ì´íŠ¸ë¡œ ì¸í•´ instantiateì— í•„ìš”í•œ argumentsë“¤ì´ ë°”ê¼ˆê³ , íŠ¹íˆ windows -> Ubuntuë¡œ OS ë³€ê²½ìœ¼ë¡œ ì¸í•´ DPì—ì„œ DDPê°€ ê°€ëŠ¥í•´ì§€ë¯€ë¡œ í•´ë‹¹ ì˜µì…˜ì— ë§ì¶° ìˆ˜ì •í•´ì•¼ í–ˆë‹¤.



## ì£¼ìš” ë²„ì „

ì½”ë“œ ë° ì„¤ì • íŒŒì¼ ìˆ˜ì •ì„ ì•¼ê¸°í•œ ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „(python==3.7.16)
hydra-core==1.3.2
omegaconf==2.3.0
pytorch-lightning==1.9.5
torch==1.13.1
torchmetrics==0.11.4



## PyTorch Lightning

ë²„ì „ ì—…ë°ì´íŠ¸ì— ë”°ë¥¸ Trainerì˜ ì¸ì ì˜µì…˜, DDP í™œìš©ì„ ìœ„í•œ LightningModule êµ¬í˜„ ë³€í™”ê°€ ìˆì—ˆë‹¤.



### Trainer

Boolean íƒ€ì…ì„ ë°›ëŠ” checkpoint_callback ì¸ìê°€ ì—†ì–´ì¡Œë‹¤.

Callbackì„ ë„£ì–´ì£¼ë©´ ìë™ìœ¼ë¡œ Trueê°€ ëœë‹¤.

gpus ì˜µì…˜ì˜ ê²½ìš°, ê¸°ì¡´ì— ê°€ìš©í•  gpuë¥¼ ì„¤ì •í•˜ëŠ” ì˜µì…˜ì´ì—ˆìœ¼ë‚˜ deviceë¡œ ì´ë¦„ì´ ë°”ë€Œì—ˆë‹¤(-1 ì…ë ¥ ì‹œ ê°€ìš© ê°€ëŠ¥í•œ ëª¨ë“  gpu ì‚¬ìš©).

accelerator ì˜µì…˜ì˜ ê²½ìš°, ê¸°ì¡´ì— DP, DDP ë“±ì˜ multi-gpu stategyë¥¼ ì„¤ì •í•˜ëŠ” ì˜µì…˜ì´ì—ˆìœ¼ë‚˜ stategyë¡œ ì´ë¦„ì´ ë°”ë€Œì—ˆê³ , í˜„ì¬ëŠ” gpu, tpu ë“±ì˜ ê°€ì†ê¸°ë¥¼ ê³ ë¥´ëŠ” ì˜µì…˜ì´ ë˜ì—ˆë‹¤.

ë”°ë¼ì„œ Trainerë¥¼ isntantiate í•˜ê¸° ìœ„í•œ trainer.yamlì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í–ˆë‹¤.

![trainer_yaml](/images/2024-01-01-second/trainer_yaml.png)



### DDP

Windows ì„œë²„ì—ì„œëŠ” nccl backendë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ gloo ë“±ì˜ ë‹¤ë¥¸ backendë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ì€ ì‹¤í—˜ì„ ê±°ì³¤ì§€ë§Œ ê²°êµ­ DDPê°€ ë¶ˆê°€ëŠ¥í•˜ì—¬ DPë¥¼ ìš¸ë©° ê²¨ìë¨¹ê¸°ë¡œ ì‚¬ìš©í–ˆë‹¤. 

Ubuntu ì„œë²„ë¡œ ë°”ë€Œë©´ì„œ DDPê°€ ê°€ëŠ¥í•´ì ¸ DDPì— ë§ê²Œ ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í–ˆë‹¤.



* ë²„ì „ ì—…ë°ì´íŠ¸ì— ì˜í•´ train/validation/test_step_end function ì‚­ì œ

DPì—ì„œëŠ” step functionì—ì„œ loggingì„ í•˜ë©´ rank_zero_only=Trueë¡œ 0ë²ˆ gpuì˜ ê²°ê³¼ë§Œ loggingì„ í•´ì•¼í•´ì„œ, step_endì—ì„œ loggingì„ í•˜ì˜€ìœ¼ë‚˜, train/validation/test_step functionì—ì„œ loggingê¹Œì§€ í•˜ê³ , DDPì— ë”°ë¼ sync_dist=Trueë¡œ ì¤˜ì„œ ëª¨ë“  gpu ê²°ê³¼ì˜ í‰ê· ìœ¼ë¡œ logging ê°€ëŠ¥í•˜ë‹¤.

ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ step_end functionì„ ì‚­ì œí•˜ê³ , stepì—ì„œ log ê¸°ëŠ¥ì„ ì¶”ê°€í–ˆë‹¤.

![step_log1](/images/2024-01-01-second/step_log1.png)

![step_log2](/images/2024-01-01-second/step_log2.png)



* ë²„ì „ ì—…ë°ì´íŠ¸ì— ì˜í•´ on_epoch_end function ì‚­ì œ

ê¸°ì¡´ì—ëŠ” on_epoch_end functionì—ì„œ metricsë¥¼ resetí•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì—¬, train/validation/test metricsë¥¼ ëª¨ë‘ on_epoch_end functionìœ¼ë¡œ reset í–ˆë‹¤.

ë²„ì „ ì—…ë°ì´íŠ¸ì— ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ on_epoch_end functionì„ ê°ê° train/validation/test_epoch_end functionìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ êµ¬í˜„í–ˆë‹¤.

![epoch_end](/images/2024-01-01-second/epoch_end.png)



## TorchMetrics

TocrhMetrics ë²„ì „ ì—…ë°ì´íŠ¸ì— ë”°ë¥¸ ì˜µì…˜ ë³€í™”ê°€ ìˆì—ˆë‹¤.



* task ì¸ì ì½”ë“œì—ì„œ ì¶”ê°€

TorchMetric ì‚¬ìš© ì‹œ, task ì¸ìë¥¼ ë°˜ë“œì‹œ ì¶”ê°€í•´ì•¼í•¨ì— ë”°ë¼ ì½”ë“œì—ì„œ ì•„ë˜ì™€ ê°™ì´ task ì¸ìë¥¼ ì¶”ê°€í•´ì¤¬ë‹¤.

![torchmetrics1](/images/2024-01-01-second/torchmetrics1.png)



* task ì¸ìì— ë”°ë¥¸ ëª¨ë‹ˆí„°ë§ ìŠ¤ì½”ì–´ ì´ë¦„ ì„¤ì • ë³€ê²½

ë˜í•œ, taskì— ì…ë ¥ëœ ì˜µì…˜ì´ metric ì´ë¦„ ì•ì— ë¶™ìœ¼ë¯€ë¡œ callback.yaml íŒŒì¼ì˜ monitor ì´ë¦„ì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í–ˆë‹¤.

![torchmetrics2](/images/2024-01-01-second/torchmetrics2.png)



## ê¸°íƒ€ ë²„ì „ ì²´í¬

* hydra-core ë²„ì „ ì²´í¬

hydra-core==1.3.2
omegaconf==2.3.0

í•´ë‹¹ ë²„ì „ìœ¼ë¡œì˜ ì¡°í•©ì´ í•„ìš”í•˜ë‹¤.

ê¸°ì¡´ì—ëŠ” hydraë¥¼ 0.xxì˜ ë²„ì „ì„ ì‚¬ìš©í•˜ë‹¤ 1.1ë¡œ ì—…ë°ì´íŠ¸ í–ˆì„ ë•Œ, main ì‹¤í–‰ yaml íŒŒì¼ì—ì„œ defualts ì˜µì…˜ì—ì„œ ë°”ë¡œ targetìœ¼ë¡œ ì‹œì‘ í›„ ì´í›„ ê³„ì¸µì  ì„ ì–¸ì´ ì—†ëŠ” íŒŒì¼ë¼ë¦¬ ë¶ˆëŸ¬ì˜¬ ë•Œ ì˜µì…˜ì´ ê¼¬ì´ëŠ” ë¬¸ì œê°€ ìˆì—ˆë‹¤.



![main_yaml](/images/2024-01-01-second/main_yaml.png)

ìœ„ main ì‹¤í–‰ yaml íŒŒì¼ì˜ defaults ì˜µì…˜ì—ì„œ,



![dataset_yaml](/images/2024-01-01-second/dataset_yaml.png)

dataset_moduleê³¼



![trainer_yaml2](/images/2024-01-01-second/trainer_yaml2.png)

trainer ì˜µì…˜ì´ ê¼¬ì˜€ë‹¤.



![architecture_yaml](/images/2024-01-01-second/architecture_yaml.png)

ìœ„ architecture_module ê°™ì€ ê²½ìš°ëŠ” ì •ìƒì ìœ¼ë¡œ ì˜µì…˜ë“¤ì´ ì ìš©ëë‹¤.



# ë¦¬íŒ©í† ë§ ì™„ë£Œ

ì•„ë˜ì™€ ê°™ì´ ëª¨ë‘ ì •ìƒ ì‹¤í–‰ ë° loggingë˜ëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤.

![wandb1](/images/2024-01-01-second/wandb1.png)

![wandb2](/images/2024-01-01-second/wandb2.png)



# ê²°ë¡ 

ìì£¼ì“°ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ê²½ìš° ì£¼ê¸°ì ì¸ ì—…ë°ì´íŠ¸ì— ë”°ë¥¸ ë³€ê²½ ì‚¬í•­ ì²´í¬ê°€ í•„ìš”í•˜ë‹¤.

í•˜ë“œì›¨ì–´ í™˜ê²½ ë³€í™”ë¥¼ ë§ì´í•  ë•Œ, stableí•œ ë²„ì „ì— ë§ì¶°ì„œ ì—…ë°ì´íŠ¸ ë° ë¦¬íŒ©í† ë§ ë˜í•œ ê¸°ì¡´ í”„ë¡œì íŠ¸ì˜ êµ¬ì„±ì„ ìƒê¸°í•˜ê³  ê°œì„ ì‹œí‚¬ ìˆ˜ ìˆëŠ” ì¢‹ì€ ê²½í—˜ì´ë‹¤.